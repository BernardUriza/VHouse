@page "/orders"
@using VHouse.Domain.Entities
@using VHouse.Infrastructure.Data
@using Microsoft.EntityFrameworkCore
@using VHouse.Web.Models
@inject VHouseDbContext DbContext
@inject IJSRuntime JSRuntime
@rendermode @(new InteractiveServerRenderMode(false))

<PageTitle>Orders Report - VHouse</PageTitle>

<div class="container-fluid">
    <div class="page-header">
        <h1>üìä Orders Report</h1>
        <div class="header-actions">
            <button class="btn btn-primary" @onclick="RefreshOrders">
                üîÑ Refresh
            </button>
            <button class="btn btn-success" @onclick="ExportToCSV">
                üì• Export CSV
            </button>
            <button class="btn btn-info @(showReportsChat ? "active" : "")" @onclick="ToggleReportsChat">
                ü§ñ AI Reports
            </button>
        </div>
    </div>

    <!-- FILTROS REALES -->
    <div class="filters-section mb-4">
        <div class="row">
            <div class="col-md-3">
                <label class="form-label">Cliente:</label>
                <select class="form-select" @bind="selectedClientFilter" @bind:after="OnFilterChanged">
                    <option value="">Todos los clientes</option>
                    <option value="Mona la Dona">üç© Mona la Dona</option>
                    <option value="Sano Market">ü•¨ Sano Market</option>
                    <option value="La Papeler√≠a">üìö La Papeler√≠a</option>
                    <option value="Walk-in">üë§ Walk-in Customer</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">Desde:</label>
                <input type="date" class="form-control" @bind="dateFrom" @bind:after="OnFilterChanged" />
            </div>
            <div class="col-md-3">
                <label class="form-label">Hasta:</label>
                <input type="date" class="form-control" @bind="dateTo" @bind:after="OnFilterChanged" />
            </div>
            <div class="col-md-3">
                <label class="form-label">Estado:</label>
                <select class="form-select" @bind="selectedStatusFilter" @bind:after="OnFilterChanged">
                    <option value="">Todos los estados</option>
                    <option value="Completed">‚úÖ Completado</option>
                    <option value="Pending">‚è≥ Pendiente</option>
                    <option value="Processing">üîÑ Procesando</option>
                    <option value="Cancelled">‚ùå Cancelado</option>
                </select>
            </div>
        </div>
    </div>

    @if (isLoading)
    {
        <div class="text-center p-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading orders...</span>
            </div>
            <p class="mt-3">Loading orders...</p>
        </div>
    }
    else if (!orders.Any())
    {
        <div class="alert alert-info" role="alert">
            <h4 class="alert-heading">No Orders Found</h4>
            <p>There are no orders in the system yet. Start by creating orders in the <a href="/pos">Point of Sale</a> system.</p>
        </div>
    }
    else
    {
        <div class="stats-cards mb-4">
            <div class="stat-card">
                <div class="stat-value">@filteredOrders.Count</div>
                <div class="stat-label">Total Orders</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">@totalRevenue.ToString("C")</div>
                <div class="stat-label">Total Revenue</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">@todayOrders</div>
                <div class="stat-label">Today's Orders</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">@averageOrderValue.ToString("C")</div>
                <div class="stat-label">Average Order</div>
            </div>
        </div>

        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Order #</th>
                        <th>Date</th>
                        <th>Customer</th>
                        <th>Items</th>
                        <th>Total</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var order in filteredOrders)
                    {
                        <tr>
                            <td><strong>#@order.Id</strong></td>
                            <td>@order.OrderDate.ToString("MM/dd/yyyy HH:mm")</td>
                            <td>
                                @if (order.Customer != null)
                                {
                                    <span>@order.Customer.CustomerName</span>
                                }
                                else
                                {
                                    <span class="text-muted">Walk-in</span>
                                }
                            </td>
                            <td>@order.OrderItems.Count items</td>
                            <td><strong>@order.TotalAmount.ToString("C")</strong></td>
                            <td>
                                <span class="badge @GetStatusBadgeClass(order.Status.ToString())">
                                    @order.Status.ToString()
                                </span>
                            </td>
                            <td>
                                <button class="btn btn-sm btn-info" @onclick="() => ShowOrderDetails(order)">
                                    üëÅ View
                                </button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }

    <!-- ü§ñ CHATBOT UNIVERSAL PARA REPORTES -->
    <VHouse.Web.Components.Shared.UniversalChatbot 
        IsVisible="@showReportsChat"
        Title="@reportsConfig.Title"
        Subtitle="@reportsConfig.Subtitle"
        HeaderIcon="@reportsConfig.HeaderIcon"
        WelcomeMessage="@reportsConfig.WelcomeMessage"
        PlaceholderText="@reportsConfig.PlaceholderText"
        QuickSuggestions="@reportsConfig.QuickSuggestions"
        ContextBuilder="@BuildReportsContext"
        ConversationType="@reportsConfig.ConversationType"
        OnClose="@CloseReportsChat"
        OnResponseReceived="@HandleReportsResponse" />
</div>

@if (selectedOrder != null)
{
    <VHouse.Web.Components.Orders.OrderDetailsModal Order="selectedOrder" OnClose="CloseModal" />
}

<style>
    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid var(--border-color);
    }

    .header-actions {
        display: flex;
        gap: 1rem;
    }

    .stats-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .stat-card {
        background: var(--background);
        border: 1px solid var(--border-color);
        border-radius: var(--radius-md);
        padding: 1.5rem;
        text-align: center;
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .stat-value {
        font-size: 2rem;
        font-weight: 700;
        color: var(--primary);
        margin-bottom: 0.5rem;
    }

    .stat-label {
        font-size: 0.875rem;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .table {
        background: var(--background);
        border-radius: var(--radius-md);
        overflow: hidden;
    }

    .table thead {
        background: var(--background-secondary);
    }

    .table th {
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.875rem;
        letter-spacing: 0.5px;
        padding: 1rem;
        border: none;
    }

    .table td {
        padding: 1rem;
        vertical-align: middle;
        border-color: var(--border-color);
    }

    .badge {
        padding: 0.5rem 1rem;
        font-weight: 500;
        border-radius: var(--radius-sm);
    }

    .badge-success {
        background-color: var(--success);
        color: white;
    }

    .badge-warning {
        background-color: var(--warning);
        color: white;
    }

    .badge-info {
        background-color: var(--info);
        color: white;
    }

    .badge-danger {
        background-color: var(--danger);
        color: white;
    }

    .btn {
        border-radius: var(--radius-sm);
        padding: 0.5rem 1rem;
        font-weight: 500;
        transition: all 0.2s;
    }

    .btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    }

    .btn-primary {
        background: var(--primary);
        border: none;
        color: white;
    }

    .btn-success {
        background: var(--success);
        border: none;
        color: white;
    }

    .btn-info {
        background: var(--info);
        border: none;
        color: white;
    }
</style>

@code {
    private List<Order> orders = new();
    private List<Order> filteredOrders = new();
    private Order? selectedOrder;
    private bool isLoading = true;
    private decimal totalRevenue;
    private int todayOrders;
    private decimal averageOrderValue;
    
    // Filtros
    private string selectedClientFilter = "";
    private DateTime? dateFrom;
    private DateTime? dateTo;
    private string selectedStatusFilter = "";
    
    // Universal Chatbot for Reports
    private bool showReportsChat = false;
    private ChatbotConfiguration reportsConfig = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadOrders();
        UpdateReportsConfig();
    }

    private async Task LoadOrders()
    {
        isLoading = true;
        StateHasChanged();

        try
        {
            orders = await DbContext.Orders
                .Include(o => o.Customer)
                .Include(o => o.OrderItems)
                    .ThenInclude(oi => oi.Product)
                .OrderByDescending(o => o.OrderDate)
                .ToListAsync();

            ApplyFilters();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading orders: {ex.Message}");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task OnFilterChanged()
    {
        ApplyFilters();
        StateHasChanged();
    }

    private void ApplyFilters()
    {
        filteredOrders = orders.AsQueryable().ToList();

        // Filtro por cliente
        if (!string.IsNullOrEmpty(selectedClientFilter))
        {
            if (selectedClientFilter == "Walk-in")
            {
                filteredOrders = filteredOrders.Where(o => o.Customer == null).ToList();
            }
            else
            {
                filteredOrders = filteredOrders.Where(o => o.Customer != null && o.Customer.CustomerName.Contains(selectedClientFilter)).ToList();
            }
        }
        else
        {
            filteredOrders = orders;
        }

        // Filtro por fecha desde
        if (dateFrom.HasValue)
        {
            filteredOrders = filteredOrders.Where(o => o.OrderDate.Date >= dateFrom.Value.Date).ToList();
        }

        // Filtro por fecha hasta
        if (dateTo.HasValue)
        {
            filteredOrders = filteredOrders.Where(o => o.OrderDate.Date <= dateTo.Value.Date).ToList();
        }

        // Filtro por estado
        if (!string.IsNullOrEmpty(selectedStatusFilter))
        {
            filteredOrders = filteredOrders.Where(o => o.Status.ToString() == selectedStatusFilter).ToList();
        }

        CalculateStatistics();
    }

    private void CalculateStatistics()
    {
        if (orders.Any())
        {
            totalRevenue = orders.Sum(o => o.TotalAmount);
            todayOrders = orders.Count(o => o.OrderDate.Date == DateTime.Today);
            averageOrderValue = totalRevenue / orders.Count;
        }
        else
        {
            totalRevenue = 0;
            todayOrders = 0;
            averageOrderValue = 0;
        }
    }

    private async Task RefreshOrders()
    {
        await LoadOrders();
    }

    private void ShowOrderDetails(Order order)
    {
        selectedOrder = order;
        StateHasChanged();
    }

    private void CloseModal()
    {
        selectedOrder = null;
        StateHasChanged();
    }

    private string GetStatusBadgeClass(string? status)
    {
        return status?.ToLower() switch
        {
            "completed" or "complete" => "badge-success",
            "pending" => "badge-warning",
            "processing" => "badge-info",
            "cancelled" => "badge-danger",
            _ => "badge-secondary"
        };
    }

    private async Task ExportToCSV()
    {
        try
        {
            var csv = new System.Text.StringBuilder();
            csv.AppendLine("Order ID,Date,Customer,Items,Total,Status");
            
            foreach (var order in orders)
            {
                var customerName = order.Customer?.CustomerName ?? "Walk-in";
                csv.AppendLine($"{order.Id},{order.OrderDate:yyyy-MM-dd HH:mm},{customerName},{order.OrderItems.Count},{order.TotalAmount},{order.Status}");
            }

            var fileName = $"orders_report_{DateTime.Now:yyyyMMdd_HHmmss}.csv";
            var bytes = System.Text.Encoding.UTF8.GetBytes(csv.ToString());
            var base64 = Convert.ToBase64String(bytes);
            
            // Create a data URL for download
            var dataUrl = $"data:text/csv;base64,{base64}";
            await JSRuntime.InvokeVoidAsync("eval", $"const a = document.createElement('a'); a.href = '{dataUrl}'; a.download = '{fileName}'; a.click();");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error exporting CSV: {ex.Message}");
        }
    }

    private object GetOrdersContextData()
    {
        return new
        {
            orders = orders,
            totalRevenue = totalRevenue,
            todayOrders = todayOrders,
            averageOrderValue = averageOrderValue,
            orderCount = orders.Count,
            productsInOrders = orders.SelectMany(o => o.OrderItems).Select(oi => oi.Product).Distinct().ToList()
        };
    }

    // ============= UNIVERSAL CHATBOT METHODS FOR REPORTS =============
    
    private void UpdateReportsConfig()
    {
        reportsConfig = ChatbotConfigurations.ForReports(orders.Cast<object>().ToList());
    }
    
    private void ToggleReportsChat()
    {
        if (!showReportsChat)
        {
            UpdateReportsConfig(); // Refresh with latest data
        }
        showReportsChat = !showReportsChat;
        StateHasChanged();
    }
    
    private async Task CloseReportsChat()
    {
        showReportsChat = false;
        StateHasChanged();
    }
    
    private async Task HandleReportsResponse(BusinessConversationResponseDto response)
    {
        // Handle specific actions from AI reports responses
        await Task.CompletedTask;
    }
    
    private string BuildReportsContext()
    {
        var context = "AN√ÅLISIS DE PEDIDOS VHOUSE - DATOS REALES:\n\n";
        
        // Estad√≠sticas generales
        context += $"üìä ESTAD√çSTICAS GENERALES:\n";
        context += $"- Total de pedidos: {filteredOrders.Count}\n";
        context += $"- Ingresos totales: {filteredOrders.Sum(o => o.TotalAmount):C}\n";
        context += $"- Pedidos hoy: {filteredOrders.Count(o => o.OrderDate.Date == DateTime.Today)}\n";
        context += $"- Valor promedio de pedido: {(filteredOrders.Any() ? filteredOrders.Average(o => o.TotalAmount) : 0):C}\n\n";
        
        // An√°lisis por cliente
        context += $"üë• AN√ÅLISIS POR CLIENTE:\n";
        var clientStats = filteredOrders.GroupBy(o => o.Customer?.CustomerName ?? "Walk-in")
                               .Select(g => new { 
                                   Cliente = g.Key, 
                                   Pedidos = g.Count(), 
                                   Total = g.Sum(o => o.TotalAmount) 
                               })
                               .OrderByDescending(x => x.Total)
                               .ToList();
        
        foreach (var client in clientStats.Take(5))
        {
            context += $"- {client.Cliente}: {client.Pedidos} pedidos, {client.Total:C} total\n";
        }
        
        // Top productos
        context += $"\nüèÜ TOP PRODUCTOS VENDIDOS:\n";
        var productStats = filteredOrders.SelectMany(o => o.OrderItems)
                                .GroupBy(oi => oi.Product.ProductName)
                                .Select(g => new { 
                                    Producto = g.Key, 
                                    Cantidad = g.Sum(oi => oi.Quantity),
                                    Ingresos = g.Sum(oi => oi.UnitPrice * oi.Quantity)
                                })
                                .OrderByDescending(x => x.Cantidad)
                                .Take(5)
                                .ToList();
        
        foreach (var product in productStats)
        {
            context += $"- {product.Producto}: {product.Cantidad} unidades vendidas, {product.Ingresos:C}\n";
        }
        
        context += $"\nüéØ INSTRUCCIONES PARA IA:\n";
        context += $"- Usa SOLO los datos reales proporcionados arriba\n";
        context += $"- Proporciona insights espec√≠ficos para el negocio vegano\n";
        context += $"- Sugiere acciones concretas basadas en los datos\n";
        context += $"- Responde en espa√±ol, de forma profesional\n";
        
        return context;
    }
}

<!-- Chatbot removed for MVP - keeping core functionality only -->

@* Created by Bernard Uriza Orozco *@