@page "/product"
@rendermode InteractiveServer
@inject ProductService ProductService

<h2>Gestión de Productos</h2>

<div class="mb-4">
    <h3>Agregar Nuevo Producto</h3>
    <form>
        <div class="row">
            <div class="col-md-4">
                <label for="productName" class="form-label">Nombre del Producto</label>
                <input id="productName" type="text" class="form-control" @bind="newProductName" placeholder="Ej. Queso Cheddar" />
            </div>
            <div class="col-md-2">
                <label for="pricePublic" class="form-label">Precio Público</label>
                <input id="pricePublic" type="number" step="0.01" class="form-control" @bind="newPricePublic" placeholder="Ej. 150.00" />
            </div>
            <div class="col-md-2">
                <label for="priceRetail" class="form-label">Precio en Punto de Venta</label>
                <input id="priceRetail" type="number" step="0.01" class="form-control" @bind="newPriceRetail" placeholder="Ej. 140.00" />
            </div>
            <div class="col-md-2">
                <label for="priceCost" class="form-label">Precio de Costo</label>
                <input id="priceCost" type="number" step="0.01" class="form-control" @bind="newPriceCost" placeholder="Ej. 100.00" />
            </div>
            <div class="col-md-2 align-self-end">
                <button type="button" class="btn btn-success" @onclick="AddProduct">Agregar Producto</button>
            </div>
        </div>
    </form>
</div>

<h3>Lista de Productos</h3>
@if (products.Any())
{
    <table class="table table-striped">
        <thead>
            <tr>
                <th>ID</th>
                <th>Nombre</th>
                <th>Precio Público</th>
                <th>Precio Punto de Venta</th>
                <th>Precio de Costo</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var product in products)
            {
                <tr>
                    <td>@product.ProductId</td>
                    <td>
                        @if (product == productBeingEdited)
                        {
                            <input type="text" class="form-control" @bind="product.ProductName" />
                        }
                        else
                        {
                            @product.ProductName
                        }
                    </td>
                    <td>
                        @if (product == productBeingEdited)
                        {
                            <input type="number" step="0.01" class="form-control" @bind="product.PricePublic" />
                        }
                        else
                        {
                            @product.PricePublic.ToString("C")
                        }
                    </td>
                    <td>
                        @if (product == productBeingEdited)
                        {
                            <input type="number" step="0.01" class="form-control" @bind="product.PriceRetail" />
                        }
                        else
                        {
                            @product.PriceRetail.ToString("C")
                        }
                    </td>
                    <td>
                        @if (product == productBeingEdited)
                        {
                            <input type="number" step="0.01" class="form-control" @bind="product.PriceCost" />
                        }
                        else
                        {
                            @product.PriceCost.ToString("C")
                        }
                    </td>
                    <td>
                        @if (product == productBeingEdited)
                        {
                            <button class="btn btn-primary btn-sm" @onclick="() => SaveEdit(product)">Guardar</button>
                            <button class="btn btn-secondary btn-sm" @onclick="CancelEdit">Cancelar</button>
                        }
                        else
                        {
                            <button class="btn btn-warning btn-sm" @onclick="() => EditProduct(product)">Editar</button>
                            <button class="btn btn-danger btn-sm" @onclick="() => DeleteProduct(product)">Eliminar</button>
                        }
                    </td>
                </tr>
            }
        </tbody>
    </table>
}
else
{
    <p>No hay productos disponibles.</p>
}

@code {
    private List<Product> products = new();
    private string newProductName = string.Empty;
    private decimal newPricePublic, newPriceRetail, newPriceCost;
    private Product? productBeingEdited = null;

    protected override async Task OnInitializedAsync()
    {
        await LoadProductsAsync();
    }

    private async Task LoadProductsAsync()
    {
        products = await ProductService.GetProductsAsync();
    }

    private async Task AddProduct()
    {
        if (string.IsNullOrWhiteSpace(newProductName) || newPricePublic <= 0 || newPriceRetail <= 0 || newPriceCost <= 0)
        {
            return; // Opcionalmente, muestra un mensaje de error.
        }

        var newProduct = new Product
            {
                ProductName = newProductName,
                PricePublic = newPricePublic,
                PriceRetail = newPriceRetail,
                PriceCost = newPriceCost
            };

        await ProductService.AddProductAsync(newProduct);
        await LoadProductsAsync();

        newProductName = string.Empty;
        newPricePublic = 0;
        newPriceRetail = 0;
        newPriceCost = 0;
    }

    private void EditProduct(Product product)
    {
        productBeingEdited = product;
    }

    private async Task SaveEdit(Product product)
    {
        await ProductService.UpdateProductAsync(product);
        productBeingEdited = null;
        await LoadProductsAsync();
    }

    private void CancelEdit()
    {
        productBeingEdited = null;
    }

    private async Task DeleteProduct(Product product)
    {
        await ProductService.DeleteProductAsync(product.ProductId);
        await LoadProductsAsync();
    }
}
