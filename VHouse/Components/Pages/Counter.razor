@page "/counter"
@using System.Text.Json
@rendermode InteractiveServer
@inject HttpClient HttpClient
@inject ChatbotService ChatbotService

<PageTitle>Gestión de Pedidos Inteligentes</PageTitle>

<h1>Counter</h1>

<p role="status">Current count: @currentCount</p>

<button class="btn btn-primary" @onclick="IncrementCount">Click me</button>


<h1>Gestión de Tickets</h1>

<h3>Procesar Pedido</h3>
<textarea @bind="userInput" placeholder="Pega aquí la descripción del pedido" rows="4" cols="50"></textarea>
<br />
<button class="btn btn-success" @onclick="ProcessOrder">Procesar Pedido</button>



@if (errorMessage != null)
{
    <p class="text-danger">@errorMessage</p>
}

@code {
    private string userInput = string.Empty;
    private string? errorMessage = null;
    private int currentCount = 0;  // Modelo de producto
    private class Product
    {
        public int ProductId { get; set; }
        public string ProductName { get; set; }
        public decimal Price { get; set; }
    }
    // Lista de productos
    private List<Product> products = new()
    {
        new Product { ProductName = "🧀 Mozzarella 1kg", Price = 205 },
        new Product { ProductName = "🧀 Mozzarella 500g", Price = 118 },
        new Product { ProductName = "🧀 Oaxaca 1kg", Price = 205 },
        new Product { ProductName = "🧀 Oaxaca 500g", Price = 118 },
        new Product { ProductName = "🥓 Jamón 270gr", Price = 58 },
        new Product { ProductName = "🌭 Parrillera 500gr", Price = 75 },
        new Product { ProductName = "🌭 Viena 470gr", Price = 75 },
        new Product { ProductName = "🍕 Peperoni 250gr", Price = 48 },
        new Product { ProductName = "🥓 Tocino 200gr", Price = 48 },
        new Product { ProductName = "🌶️ Chorizo Rojo 500gr (S/F)", Price = 92 },
        new Product { ProductName = "🌶️ Chorizo Verde 400gr (S/F)", Price = 92 },
        new Product { ProductName = "🎄 Seitan Navideño", Price = 228 },
        new Product { ProductName = "🍦 Leche Condensada Veggie Express", Price = 90.85M },
        new Product { ProductName = "🍯 Cajeta sin azúcar", Price = 90.25M },
        new Product { ProductName = "🥛 Crema", Price = 51.75M },
        new Product { ProductName = "🧀 Queso Crema", Price = 69.00M },
        new Product { ProductName = "🧀 Panela", Price = 63.25M },
        new Product { ProductName = "🧀 Parmesano", Price = 58.65M },
        new Product { ProductName = "🧀 Ranchero", Price = 51.75M },
        new Product { ProductName = "🌶️ Dip Jalapeño", Price = 50.14M },
        new Product { ProductName = "🧂 Aderezo Queso Azul", Price = 74.75M },
        new Product { ProductName = "🍖 Chicharrón Seitan", Price = 90.27M },
        new Product { ProductName = "🌮 Molida Quinoa", Price = 69.00M },
        new Product { ProductName = "🌮 Suadero Quinoa", Price = 69.00M },
        new Product { ProductName = "🥓 Tocino Veggie Express 200gr", Price = 56.35M },
        new Product { ProductName = "🍕 Pepperoni Veggie Express 200gr", Price = 57.50M },
        new Product { ProductName = "🍲 Consomé Vegano", Price = 81.65M },
        // Más productos...
    };
    // Lista de ticket generado
    private List<Product> ticket = new();
    private void IncrementCount()
    {
        currentCount++;
    } 
    private async Task ProcessOrder()
    {
        errorMessage = null;
        try
        {
            if (string.IsNullOrWhiteSpace(userInput))
            {
                errorMessage = "El pedido está vacío. Por favor ingresa un pedido válido.";
                return;
            }

            string catalogJson = JsonSerializer.Serialize(products.Select(p => new { p.ProductId, p.ProductName }));

            var extractedProductIds = await ChatbotService.ExtractProductIdsAsync(catalogJson, userInput);

            if (extractedProductIds == null || !extractedProductIds.Any())
            {
                errorMessage = "No se encontraron productos en el pedido.";
                return;
            }

            var selectedProducts = products.Where(p => extractedProductIds.Contains(p.ProductId)).ToList();
            ticket.AddRange(selectedProducts);

            // Rate-limiting: Wait before processing another request
            await Task.Delay(200); // 200ms delay
        }
        catch (Exception ex)
        {
            errorMessage = $"Ocurrió un error al procesar el pedido: {ex.Message}";
        }
    }


}
@* 
<h3>Lista de Precios</h3>

<table>
    <thead>
        <tr>
            <th>Producto</th>
            <th>Precio</th>
            <th>Acción</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var product in products)
        {
            <tr>
                <td>@product.ProductName</td>
                <td>
                    <input type="number" step="0.01" value="@product.Price"
                           @oninput="(e) => UpdatePrice(product, e.Value.ToString())" />
                </td>
                <td>
                    <button @onclick="() => AddToTicket(product)">Generar Ticket</button>
                </td>
            </tr>
        }
    </tbody>
</table>

<h3>Tickets Generados</h3>

@if (tickets.Any())
{
    <table>
        <thead>
            <tr>
                <th>Producto</th>
                <th>Precio</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var ticket in tickets)
            {
                <tr>
                    <td>@ticket.ProductName</td>
                    <td>@ticket.Price.ToString("C")</td>
                </tr>
            }
        </tbody>
    </table>
    <h4>Total: @tickets.Sum(t => t.Price).ToString("C")</h4>
}
else
{
    <p>No hay tickets generados.</p>
}

@code {
    private string userInput = string.Empty;
    private string? errorMessage = null;

   

    // Lista de tickets generados
    private List<Product> tickets = new();

    // Método para procesar el texto del pedido
    private async Task ProcessOrder()
    {
        errorMessage = null;
        try
        {
            // Convert products to catalog JSON format
            string catalogJson = JsonSerializer.Serialize(products.Select(p => new { p.ProductId, p.ProductName }));

            // Call the ChatbotService to extract product IDs
            var extractedProductIds = await ChatbotService.ExtractProductIdsAsync(catalogJson, userInput);

            // Find products matching the extracted IDs
            var selectedProducts = products.Where(p => extractedProductIds.Contains(p.ProductId)).ToList();

            // Add selected products to the ticket
            tickets.AddRange(selectedProducts);
        }
        catch (Exception ex)
        {
            errorMessage = $"Ocurrió un error al procesar el pedido: {ex.Message}";
        }
    }

    // Método para agregar productos al ticket
    private void AddToTicket(Product product)
    {
        tickets.Add(product);
    }

    // Método para actualizar el precio de un producto
    private void UpdatePrice(Product product, string newValue)
    {
        if (decimal.TryParse(newValue, out var newPrice))
        {
            product.Price = newPrice;
        }
    }

    // Modelo de producto
    private class Product
    {
        public int ProductId { get; set; }
        public string ProductName { get; set; }
        public decimal Price { get; set; }
    }
}
 *@